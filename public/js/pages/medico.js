import { isValid } from '../utils/sessionCode.js'; import { joinSession } from '../utils/signaling-rtdb.js';
const input=document.getElementById('sessionCode'); const btn=document.getElementById('btnConectar'); const statusEl=document.getElementById('status'); const rxText=document.getElementById('rxText'); const rxJSON=document.getElementById('rxJSON');
let pc=null; let stopSignal=null; function setStatus(m){ statusEl.textContent=m||''; }
btn?.addEventListener('click',async()=>{ const code=(input.value||'').replace(/\D/g,'').slice(0,4); if(!isValid(code)){ setStatus('Código inválido.'); return;} try{ setStatus('Conectando…'); pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]}); pc.ondatachannel=(ev)=>{ const ch=ev.channel; ch.onopen=()=>setStatus('Conectado. Aguardando dados…'); ch.onmessage=(mev)=>{ try{ const data=JSON.parse(mev.data); rxText.textContent=data?.text||'—'; rxJSON.textContent=JSON.stringify({meta:data?.meta,profissional:data?.profissional},null,2); setStatus('Dados recebidos.'); }catch(e){ setStatus('Erro ao ler dados.'); } }; ch.onclose=()=>setStatus('Canal encerrado.'); }; stopSignal=await joinSession(code,pc); } catch(e){ setStatus('Erro: '+(e?.message||e)); } window.addEventListener('beforeunload',()=>{ try{pc?.close();}catch{} try{stopSignal&&stopSignal();}catch{} },{once:true}); });