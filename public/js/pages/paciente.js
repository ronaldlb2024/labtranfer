import { newCode, isValid } from '../utils/sessionCode.js'; import { createSession } from '../utils/signaling-rtdb.js';
const elIn=document.getElementById('pdfInput'); const outText=document.getElementById('outText'); const outJSON=document.getElementById('outJSON'); const btnLimpar=document.getElementById('btnLimpar'); const codeEl=document.getElementById('code'); const btnNovoCodigo=document.getElementById('btnNovoCodigo'); const btnConectar=document.getElementById('btnConectar'); const statusEl=document.getElementById('status');
let extracted={text:'',meta:{}}; let dc=null; let pc=null; let stopSignal=null;
const worker=new Worker('js/worker.js',{type:'module'});
function resetUI(){ outText.textContent='—'; outJSON.textContent='—'; statusEl.textContent=''; extracted={text:'',meta:{}}; } resetUI();
btnLimpar?.addEventListener('click',resetUI);
elIn?.addEventListener('change',async()=>{const f=elIn.files?.[0]; if(!f)return; const ab=await f.arrayBuffer(); outText.textContent='Lendo PDF…'; outJSON.textContent='Analisando…'; worker.onmessage=(ev)=>{const {text,meta,error}=ev.data||{}; if(error){ outText.textContent='Erro: '+error; outJSON.textContent='—'; extracted={text:'',meta:{}}; return;} extracted={text:text||'',meta:meta||{}}; outText.textContent=extracted.text||'Vazio'; outJSON.textContent=JSON.stringify({pages:meta?.pages,chars:(text||'').length},null,2);}; worker.postMessage({pdf:ab},[ab]); });
btnNovoCodigo?.addEventListener('click',()=>{ codeEl.textContent=newCode(); });
function setBusy(b){ if(b){ btnConectar.setAttribute('disabled','true'); statusEl.textContent='Conectando…'; } else { btnConectar.removeAttribute('disabled'); } }
btnConectar?.addEventListener('click',async()=>{ const code=String(codeEl.textContent||'').trim(); if(!isValid(code)){ statusEl.textContent='Gere um código de 4 dígitos.'; return;} if(!extracted.text){ statusEl.textContent='Selecione um PDF antes de conectar.'; return;} try{ setBusy(true); pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]}); dc=pc.createDataChannel('data'); dc.onopen=()=>{ statusEl.textContent='Conectado. Enviando…'; const payload={text:extracted.text,meta:extracted.meta,profissional:'ShareLab Paciente'}; dc.send(JSON.stringify(payload)); statusEl.textContent='Enviado.'; }; dc.onclose=()=>{ statusEl.textContent='Canal encerrado.'; }; stopSignal=await createSession(code,pc); } catch(e){ console.error(e); statusEl.textContent='Erro: '+(e?.message||e); setBusy(false);} window.addEventListener('beforeunload',()=>{ try{pc?.close();}catch{} try{stopSignal&&stopSignal();}catch{} },{once:true}); });